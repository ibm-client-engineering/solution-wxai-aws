---
id: CP4D
sidebar_position: 1
title: CP4D Installation
custom_edit_url: null
---

## Installing Multi Cloud Gateway

### Download binary

Download the `noobaa` tar file from here **link to be added**

Extract the `nooba-amd64`

```tsx
tar zxvf mcg-cli-4.15.0-linux-amd64.tar.gz

mv noobaa-amd64 /usr/local/bin/noobaa
```

### Install the local storage operator

```tsx
oc apply -f https://raw.githubusercontent.com/openshift/local-storage-operator/master/examples/olm/catalog-create-subscribe.yaml
```




## Installing CP4D Cli

### Download binary
CP4D CLI can be found at the following link.

https://github.com/IBM/cpd-cli/releases/download/v13.1.4/cpd-cli-linux-EE-13.1.4.tgz


:::note
 This binary is for linux, if running from a windows machine, please use the linux binary but run it from Windows Subsystem for Linux.

 Also as of this writing the latest version of the cli is 13.1.4.
:::

```tsx
wget https://github.com/IBM/cpd-cli/releases/download/v13.1.4/cpd-cli-linux-EE-13.1.4.tgz
```

Extract the files:

```
tar xzvf https://github.com/IBM/cpd-cli/releases/download/v13.1.4/cpd-cli-linux-EE-13.1.4.tgz
```

This will create the following directory:

```tsx
cpd-cli-linux-EE-13.1.4-109
```

### Configure environmental vars

The following creates a CPD env file


```tsx
cat<<EOF> cpd_vars_48.sh
#===============================================================================

# Cloud Pak for Data installation variables

#===============================================================================

  

# ------------------------------------------------------------------------------
# Client workstation
# ------------------------------------------------------------------------------

# Set the following variables if you want to override the default behavior of the Cloud Pak for Data CLI.
#
# To export these variables, you must uncomment each command in this section.
# export CPD_CLI_MANAGE_WORKSPACE=<enter a fully qualified directory>
# export OLM_UTILS_LAUNCH_ARGS=<enter launch arguments>

# ------------------------------------------------------------------------------
# Cluster
# ------------------------------------------------------------------------------

export OCP_URL=<enter your Red Hat OpenShift Container Platform URL>
export OPENSHIFT_TYPE=self-managed
export IMAGE_ARCH=amd64
export OCP_USERNAME=kubeadmin
export OCP_PASSWORD=<enter your password>
export SERVER_ARGUMENTS="--server=${OCP_URL}"
export CPDM_OC_LOGIN="cpd-cli manage login-to-ocp ${SERVER_ARGUMENTS} ${LOGIN_ARGUMENTS}"
export OC_LOGIN="oc login ${OCP_URL} ${LOGIN_ARGUMENTS}"

# export OCP_TOKEN=<enter your token>
# export LOGIN_ARGUMENTS="--username=${OCP_USERNAME} --password=${OCP_PASSWORD}"
# export LOGIN_ARGUMENTS="--token=${OCP_TOKEN}"

# ------------------------------------------------------------------------------

# Projects

# ------------------------------------------------------------------------------

export PROJECT_CERT_MANAGER=ibm-cert-manager
export PROJECT_LICENSE_SERVICE=ibm-license-server
export PROJECT_SCHEDULING_SERVICE=ibm-scheduler
export PROJECT_CPD_INST_OPERATORS=cpd-operators
export PROJECT_CPD_INST_OPERANDS=cpd

# export PROJECT_IBM_EVENTS=<enter your IBM Events Operator project>
# export PROJECT_PRIVILEGED_MONITORING_SERVICE=<enter your privileged monitoring service project>
# export PROJECT_CPD_INSTANCE_TETHERED=<enter your tethered project>
# export PROJECT_CPD_INSTANCE_TETHERED_LIST=<a comma-separated list of tethered projects>

# ------------------------------------------------------------------------------
# Storage
# ------------------------------------------------------------------------------

export STG_CLASS_BLOCK=nfs-client
export STG_CLASS_FILE=nfs-client

# ------------------------------------------------------------------------------
# IBM Entitled Registry
# ------------------------------------------------------------------------------

export IBM_ENTITLEMENT_KEY=<enter your IBM entitlement API key>

# ------------------------------------------------------------------------------
# Private container registry
# ------------------------------------------------------------------------------

# Set the following variables if you mirror images to a private container registry.
#
# To export these variables, you must uncomment each command in this section. 

# export PRIVATE_REGISTRY_LOCATION=<enter the location of your private container registry>
# export PRIVATE_REGISTRY_PUSH_USER=<enter the username of a user that can push to the registry>
# export PRIVATE_REGISTRY_PUSH_PASSWORD=<enter the password of the user that can push to the registry>
# export PRIVATE_REGISTRY_PULL_USER=<enter the username of a user that can pull from the registry>
# export PRIVATE_REGISTRY_PULL_PASSWORD=<enter the password of the user that can pull from the registry>

  
  

# ------------------------------------------------------------------------------
# Cloud Pak for Data version
# ------------------------------------------------------------------------------

export VERSION=4.8.4

# ------------------------------------------------------------------------------
# Components
# ------------------------------------------------------------------------------

#export COMPONENTS=ibm-cert-manager,ibm-licensing,scheduler,cpfs,cpd_platform,ws,wml,openpages,wkc,watson_assistant
export COMPONENTS=ibm-cert-manager,ibm-licensing,scheduler,cpfs,cpd_platform


# export COMPONENTS_TO_SKIP=<component-ID-1>,<component-ID-2>

# ------------------------------------------------------------------------------
# watsonx Orchestrate
# ------------------------------------------------------------------------------

# export PROJECT_IBM_APP_CONNECT=<enter your IBM App Connect in containers project>
# export AC_CASE_VERSION=<version>
# export AC_CHANNEL_VERSION=<version>
EOF
```

You will need to open the resultant `cpd_vars_48.sh` file and update the following vars:

```tsx
OCP_URL
OCP_PASSWORD
IBM_ENTITLEMENT_KEY
```

By default we set our storage classes to the `nfs-client` storage class. Your mileage may vary.

If you are an IBM employee, entitlement key can be fetched from [here](https://myibm.ibm.com/products-services/containerlibrary)

The `OCP_URL` can be pulled with this command:
```tsx
oc cluster-info
Kubernetes control plane is running at https://api.wxai.cpdu8vscs.ibmworkshops.com:6443

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
```

The kubeadmin password can be found in the build directory for the cluster under `auth/kubeadmin-password`

### Login to the cluster with cpd-cli

Source the env file

`source cpd_vars_48.sh`

login with cpd-cli
```
cpd-cli manage login-to-ocp \
--username=${OCP_USERNAME} \
--password=${OCP_PASSWORD} \
--server=${OCP_URL}
```
### Add the entitlement key

```tsx
cpd-cli manage add-icr-cred-to-global-pull-secret \
--entitled_registry_key=${IBM_ENTITLEMENT_KEY}
```

## Installing CP4D 

:::note
Important links:

This apparently is a requirement for watsonx Assistant
https://www.ibm.com/docs/en/cloud-paks/cp-data/4.8.x?topic=software-installing-red-hat-openshift-serverless-knative-eventing


:::

### Authorizing instances

This step creates all required projects, creates the NamespaceScope operator in the operators project, and binds the applied role to the service account of the NamespaceScope operator.

```tsx
cpd-cli manage authorize-instance-topology \
--cpd_operator_ns=${PROJECT_CPD_INST_OPERATORS} \
--cpd_instance_ns=${PROJECT_CPD_INST_OPERANDS}
```

**This was successful**

### Installation of shared components

These two tasks come from here:
https://www.ibm.com/docs/en/cloud-paks/cp-data/4.8.x?topic=cluster-installing-shared-components

```tsx
cpd-cli manage apply-cluster-components \
--release=${VERSION} \
--license_acceptance=true \
--cert_manager_ns=${PROJECT_CERT_MANAGER} \
--licensing_ns=${PROJECT_LICENSE_SERVICE}
```

This installed broken and now subsequent runs try to upgrade and break

```tsx
[✔] Successfully patched subscription ibm-cert-manager-operator in ibm-cert-manager
[INFO] Waiting for operator ibm-cert-manager-operator to be upgraded
[INFO] RETRYING: Waiting for operator ibm-cert-manager-operator to be upgraded (10 left)
[INFO] RETRYING: Waiting for operator ibm-cert-manager-operator to be upgraded (9 left)
[INFO] RETRYING: Waiting for operator ibm-cert-manager-operator to be upgraded (8 left)
[INFO] RETRYING: Waiting for operator ibm-cert-manager-operator to be upgraded (7 left)
[INFO] RETRYING: Waiting for operator ibm-cert-manager-operator to be upgraded (6 left)
[INFO] RETRYING: Waiting for operator ibm-cert-manager-operator to be upgraded (5 left)
[INFO] RETRYING: Waiting for operator ibm-cert-manager-operator to be upgraded (4 left)
[INFO] RETRYING: Waiting for operator ibm-cert-manager-operator to be upgraded (3 left)
[INFO] RETRYING: Waiting for operator ibm-cert-manager-operator to be upgraded (2 left)
[INFO] RETRYING: Waiting for operator ibm-cert-manager-operator to be upgraded (1 left)
[✘] Error in /tmp/work/cpfs_scripts/4.8.4/cp3pt0-deployment/common/utils.sh at line 126 in function wait_for_condition: Timeout after 5 minutes waiting for operator ibm-cert-manager-operator to be upgraded
[ERROR] 2024-03-29T19:38:59.356382Z cmd.Run() failed with exit status 1
[ERROR] 2024-03-29T19:38:59.356662Z Command exception: The apply-cluster-components command failed (exit status 1). You may find output and logs in the /home/ec2-user/UPI-Install/cpd-cli-workspace/olm-utils-workspace/work directory.
[ERROR] 2024-03-29T19:38:59.357131Z RunPluginCommand:Execution error:  exit status 1
```


Install the scheduler

```tsx
cpd-cli manage apply-scheduler \
--release=${VERSION} \
--license_acceptance=true \
--scheduler_ns=${PROJECT_SCHEDULING_SERVICE}
```

This breaks too

```tsx
TASK [utils : get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0] ***********************************************************************************************************
Not ready yet - Retrying: get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0 (20 Retries left)
Not ready yet - Retrying: get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0 (19 Retries left)
Not ready yet - Retrying: get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0 (18 Retries left)
Not ready yet - Retrying: get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0 (17 Retries left)
Not ready yet - Retrying: get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0 (16 Retries left)
Not ready yet - Retrying: get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0 (15 Retries left)
Not ready yet - Retrying: get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0 (14 Retries left)
Not ready yet - Retrying: get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0 (13 Retries left)
Not ready yet - Retrying: get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0 (12 Retries left)
Not ready yet - Retrying: get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0 (11 Retries left)
Not ready yet - Retrying: get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0 (10 Retries left)
Not ready yet - Retrying: get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0 (9 Retries left)
Not ready yet - Retrying: get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0 (8 Retries left)
Not ready yet - Retrying: get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0 (7 Retries left)
Not ready yet - Retrying: get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0 (6 Retries left)
Not ready yet - Retrying: get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0 (5 Retries left)
Not ready yet - Retrying: get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0 (4 Retries left)
Not ready yet - Retrying: get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0 (3 Retries left)
Not ready yet - Retrying: get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0 (2 Retries left)
Not ready yet - Retrying: get installedCSV for Subscription: ibm-cpd-scheduling-catalog-subscription .v1.21.0 (1 Retries left)
fatal: [localhost]: FAILED! => {"api_found": true, "attempts": 20, "changed": false, "resources": [{"apiVersion": "operators.coreos.com/v1alpha1", "kind": "Subscription", "metadata": {"creationTimestamp": "2024-03-29T23:36:29Z", "generation": 1, "labels": {"operators.coreos.com/ibm-cpd-scheduling-operator.ibm-scheduler": ""}, "managedFields": [{"apiVersion": "operators.coreos.com/v1alpha1", "fieldsType": "FieldsV1", "fieldsV1": {"f:metadata": {"f:labels": {".": {}, "f:operators.coreos.com/ibm-cpd-scheduling-operator.ibm-scheduler": {}}}}, "manager": "Go-http-client", "operation": "Update", "time": "2024-03-29T23:36:29Z"}, {"apiVersion": "operators.coreos.com/v1alpha1", "fieldsType": "FieldsV1", "fieldsV1": {"f:spec": {".": {}, "f:channel": {}, "f:installPlanApproval": {}, "f:name": {}, "f:source": {}, "f:sourceNamespace": {}}}, "manager": "OpenAPI-Generator", "operation": "Update", "time": "2024-03-29T23:36:29Z"}, {"apiVersion": "operators.coreos.com/v1alpha1", "fieldsType": "FieldsV1", "fieldsV1": {"f:status": {".": {}, "f:catalogHealth": {}, "f:conditions": {}, "f:lastUpdated": {}}}, "manager": "catalog", "operation": "Update", "subresource": "status", "time": "2024-03-29T23:36:29Z"}], "name": "ibm-cpd-scheduling-catalog-subscription", "namespace": "ibm-scheduler", "resourceVersion": "129548", "uid": "e781748d-b045-40ce-bc85-caad228c74cc"}, "spec": {"channel": "v1.21", "installPlanApproval": "Automatic", "name": "ibm-cpd-scheduling-operator", "source": "ibm-cpd-scheduling-catalog", "sourceNamespace": "ibm-scheduler"}, "status": {"catalogHealth": [{"catalogSourceRef": {"apiVersion": "operators.coreos.com/v1alpha1", "kind": "CatalogSource", "name": "ibm-cpd-scheduling-catalog", "namespace": "ibm-scheduler", "resourceVersion": "129219", "uid": "e9d2e106-5794-427f-a865-c90dae22eb30"}, "healthy": true, "lastUpdated": "2024-03-29T23:36:29Z"}, {"catalogSourceRef": {"apiVersion": "operators.coreos.com/v1alpha1", "kind": "CatalogSource", "name": "index-olm-mirror-redhat-operator-index", "namespace": "openshift-marketplace", "resourceVersion": "129238", "uid": "e41f9647-e5eb-45bd-a7ee-9fdd3bb1b411"}, "healthy": true, "lastUpdated": "2024-03-29T23:36:29Z"}], "conditions": [{"lastTransitionTime": "2024-03-29T23:36:29Z", "message": "all available catalogsources are healthy", "reason": "AllCatalogSourcesHealthy", "status": "False", "type": "CatalogSourcesUnhealthy"}, {"message": "failed to populate resolver cache from source index-olm-mirror-redhat-operator-index/openshift-marketplace: failed to list bundles: rpc error: code = Unavailable desc = connection error: desc = \"transport: Error while dialing dial tcp 172.30.212.36:50051: connect: connection refused\"", "reason": "ErrorPreventedResolution", "status": "True", "type": "ResolutionFailed"}], "lastUpdated": "2024-03-29T23:36:29Z"}}]}

TASK [utils : fail] ******************************************************************************************************************************************************************************************
fatal: [localhost]: FAILED! => {"changed": false, "msg": "Playbook fail while running 'wait_for_csv.yml'. Fail to wait for subscription 'ibm-cpd-scheduling-catalog-subscription' in namespace 'ibm-scheduler' to be ready"}

PLAY RECAP ***************************************************************************************************************************************************************************************************
localhost                  : ok=48   changed=8    unreachable=0    failed=1    skipped=52   rescued=1    ignored=0

[ERROR] 2024-03-29T19:46:14.450030Z cmd.Run() failed with exit status 2
[ERROR] 2024-03-29T19:46:14.450131Z Command exception: The apply-scheduler command failed (exit status 2). You may find output and logs in the /home/ec2-user/UPI-Install/cpd-cli-workspace/olm-utils-workspace/work directory.
[ERROR] 2024-03-29T19:46:14.450773Z RunPluginCommand:Execution error:  exit status 1
```

### Installation of primary CPD components

***This might be legacy from my notes, but the complaint was that the cert manager wasn't found***

```tsx
cpd-cli manage apply-olm \
--release=${VERSION} \
--cpd_operator_ns=${PROJECT_CPD_INST_OPERATORS} \
--components=${COMPONENTS}
```


### Setup instance topology

```tsx
cpd-cli manage setup-instance-topology \
--release=${VERSION} \
--cpd_operator_ns=${PROJECT_CPD_INST_OPERATORS} \
--cpd_instance_ns=${PROJECT_CPD_INST_OPERANDS} \
--license_acceptance=true \
--block_storage_class=${STG_CLASS_BLOCK}
```

This of course breaks with this chicken/egg noise

```tsx
#  Smoke test for Cert Manager existence...
error: the server doesn't have a resource type "issuer"
error: the server doesn't have a resource type "certificate"
[DEBUG] Creating Issuer test-issuer in namespace cpd-operators .
[INFO] Creating following issuer:

apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: test-issuer
  namespace: cpd-operators
spec:
  selfSigned: {}

error: resource mapping not found for name: "test-issuer" namespace: "cpd-operators" from "STDIN": no matches for kind "Issuer" in version "cert-manager.io/v1"
ensure CRDs are installed first
[✘] Error in /tmp/work/cpfs_scripts/4.8.4/cp3pt0-deployment/common/utils.sh at line 819 in function create_issuer: Failed to create Issuer test-issuer in cpd-operators

[ERROR] 2024-03-29T19:51:41.410225Z cmd.Run() failed with exit status 1
[ERROR] 2024-03-29T19:51:41.411092Z Command exception: The setup-instance-topology command failed (exit status 1). You may find output and logs in the /home/ec2-user/UPI-Install/cpd-cli-workspace/olm-utils-workspace/work directory.
[ERROR] 2024-03-29T19:51:41.413524Z RunPluginCommand:Execution error:  exit status 1
```
  